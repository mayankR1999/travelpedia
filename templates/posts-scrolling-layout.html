{% if posts %}
    {% for post in posts %}
        <div class="custom-card">
            <!------------------------------------POST Header Start---------------------------------------->
            <div class="custom-card-header">
                <img src="{{post.owner.avatar.url}}" alt="Error!" style="border: 1.5px rgb(240, 240, 240) solid; border-radius: 20px;" height="40px" width="40px">
                {{post.owner.first_name}} {{post.owner.last_name}}
                <a href="{% url 'show_user_profile' post.owner.id %}">@{{ post.owner.username }}</a>
                {% if post.owner == user %}
                    <div style="float: right;">
                        <div class="dropdown-bars" data-toggle="dropdown">
                            {% load cache %}
                            {% cache 3600 horizontal_bars_icon %}
                            <i class="fas fa-bars fa-lg" ></i>
                            {% endcache %}
                        </div>
                        <div class="dropdown-menu">
                            <a class="dropdown-item" id="delete_post" data-catid="{{ post.id }}"">Delete</a>
                        </div>
                    </div>
                {% else %}
                    <!------------------Refer this for future use------------>
                    {% if post.owner in info.following %}
                    <style>.custom-follow-button{display: none;}</style>
                    {% else %}
                    <style>.show-following-or-not{display: none;}</style>
                    {% endif %}
                    <!------------------------------------------------------->
                    <button style="float: right;" class="custom-follow-button" data-catid="{{post.owner.id}}" id="follow{{post.owner.id}}">Follow</button>
                    <button style="float: right;" class="show-following-or-not" data-catid="{{post.owner.id}}" id="unfollow{{post.owner.id}}">Following</button>
                {% endif %}
                <div class="place-heading">{{ post.place }}</div>
            </div>
            <!-------------------------------------POST Header End----------------------------------------->

            <div class="custom-card-body"><img src="{{post.img.url}}" alt="Couldn't load image!" height="auto" width="100%"></div>

            <!-------------------------------------POST Footer Start--------------------------------------->
            <div class="custom-card-footer">
                {{ post.experience }}<br><br>
                <div style="margin-left: -5px;">
                    {% if user in post.liked_by %}
                        <button class="fa fa-heart likebutton" id="lb{{post.id}}" data-catid="{{ post.id }}" href="#"></button>
                    {% else %}
                        <button class="far fa-heart likebutton" id="lb{{post.id}}" data-catid="{{ post.id }}" href="#"></button>
                    {% endif %}
                    <button class="far fa-comment likebutton" onclick="load_comment(postID = {{post.id}})"></button>
                </div>
                <div id="{{post.id}}" style="font-family: Inter; font-weight: 600; margin: 5px 0px 0px 2px; color: darkgrey; font-size: .9em;">{{ post.total_likes }} likes <span>&#183;</span> x comments</div>
            </div>
            <!-------------------------------------POST Footer End----------------------------------------->
            
            <!---------------------------------POST Comments Box Start------------------------------------->
            <div class="comment-box-wrapper" id="comment-box-wrapper{{post.id}}">
                <div class="comments-option-bar">Sort by</div>
                <div class="comments-layout" id="comments-layout{{post.id}}">
                </div>
                <div class="add-comment-form">
                    <input class="enter-comment-text-bar" id="comment{{post.id}}" type="text" placeholder="Add a comment" name="comment_text" required>
                    <button class="btn btn-primary add-comment-button" data-catid="{{ post.id }}">Add</button>
                </div>
            </div>
            <!----------------------------------POST Comments Box End-------------------------------------->
        </div>
        
    {% endfor %}
{% else %}
    <h4 style="text-align: center; margin-top:40px">No posts to show!</h4>
{% endif %}

<script>
    $('.likebutton').click(function(){
        var catid = $(this).attr("data-catid");
        const element = document.querySelector('#lb'+catid);
        if(element.classList.contains('fa')){
            element.classList.remove('fa');
            element.classList.add('far');
        }
        else{
            element.classList.remove('far');
            element.classList.add('fa');
        }
        $.ajax(
        {
            type:"GET",
            url: "{% url 'like_post' %}",
            data:{
                post_id: catid
            },
            success: function(data)
            {   
                if(data['numberoflikes'] == 1){
                    $( '#'+catid ).text(data['numberoflikes'] + ' like');
                }
                else{
                    $( '#'+catid ).text(data['numberoflikes'] + ' likes');
                }
            }
         })
    });

    $('#delete_post').click(function(){
        var catid = $(this).attr("data-catid");
        $.ajax(
        {
            type:"GET",
            url: "{% url 'delete_post' %}",
            data:{
                post_id: catid
            },
            success: function(data)
            {
                location.reload()
            }
        })
    })

    $('.custom-follow-button').click(function(){
        var catid = $(this).attr("data-catid");
        $.ajax(
        {
            type:"GET",
            url: "{% url 'follow_toggle_request' %}",
            data:{
                user_id: catid,
                request_type: 'follow'
            },
            success: function(data){
                $('#follow' + catid).hide();
                $('#unfollow' + catid).show();
            }
        })
    })
    
    $('.show-following-or-not').click(function(){
        var catid = $(this).attr("data-catid");
        $.ajax(
        {
            type: "GET",
            url: "{% url 'follow_toggle_request' %}",
            data:{
                user_id: catid,
                request_type: 'unfollow'
            },
            success: function(data){
                $('#unfollow' + catid).hide();
                $('#follow' + catid).show();
            }
        })
    })

    $('.add-comment-button').click(function(){
        var catid = $(this).attr('data-catid');
        var comment = document.getElementById('comment'+catid);
        var comment_text = comment.value;

        $.ajax({
            type: 'POST',
            url: '{% url "add_comment" %}',
            data: {
                postID: catid,
                comment_text: comment_text,
                csrfmiddlewaretoken: '{{ csrf_token }}'
            },
            success: function(response){
                comment.value = '';
                load_comment(catid);
            }
        })
    })

    function load_comment(postID){
        if ($('#comment-box-wrapper'+postID).is(":visible")){
            $('#comment-box-wrapper'+postID).slideUp();
        }else{
            $.ajax(
            {
                type: "GET", 
                url: "{% url 'load_comments' %}",
                data: {
                    postID: postID
                },
                success: function(data){
                    var comments = JSON.parse(data);
                    var new_inner_html = '';
                    for (var comment in comments){
                        var comment_likes = '';
                        if (comments[comment].total_likes == 1){
                            comment_likes = '1 like';
                        }else{
                            comment_likes = comments[comment].total_likes + ' likes';
                        }
                        new_inner_html +=
                        ('<div class="comment">'+
                            '<img src="' + comments[comment].user_details.avatar_url + '" alt="Error!" style="border: 1.5px rgb(240, 240, 240) solid; border-radius: 20px; margin-right: 10px" height="40px" width="40px">' +
                            '<div style="line-height: 120%; margin-right: 20px; width: 100%;">' +
                                '<span style="font-weight: 650;">' + comments[comment].user.username + ' </span>' +
                                '<span>' + comments[comment].text + '</span>' + 
                                '<div class="comment-info">' + 
                                    '<span class="comment-time-elapsed">' + comments[comment].time_elapsed + '</span>' + 
                                    '<span class="comment-likes">' + comment_likes + '</span>' +
                                '</div>' +
                            '</div>' +
                            '<i style="margin: 5px 5px 0px 0px;" class="far fa-heart"></i>' +
                        '</div>');
                    }
                    document.getElementById('comments-layout'+postID).innerHTML = new_inner_html;
                    $('#comment-box-wrapper'+postID).slideDown();
                    document.getElementById('comment-box-wrapper'+postID).style.display = 'flex';
                }
            })
        }
    }
</script>
